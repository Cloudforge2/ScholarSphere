<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title th:text="'Paper Summary - ' + ${title}">Paper Summary - ScholarSphere</title>
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background-color: #f8fafc;
      color: #1e293b;
    }

    header {
      background: linear-gradient(90deg, #0d4f4c, #2563eb);
      color: white;
      text-align: center;
      padding: 20px 0;
      font-size: 24px;
      font-weight: 600;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .main-container {
      display: grid;
      grid-template-columns: 1fr 1.2fr;
      gap: 25px;
      padding: 30px 40px;
      height: calc(100vh - 80px);
      box-sizing: border-box;
    }

    /* Left panel */
    .summary-panel {
      background: white;
      border-radius: 18px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
      padding: 25px 30px;
      overflow-y: auto;
    }

    .summary-panel h2 {
      color: #111827;
      font-size: 22px;
      margin-bottom: 15px;
    }

    .summary-panel h3 {
      margin-top: 20px;
      color: #0d4f4c;
      font-size: 18px;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 5px;
    }

    .summary-content {
      margin-top: 10px;
      line-height: 1.7;
      font-size: 15px;
    }

    .summary-content h4.section-title {
      margin-top: 20px;
      padding: 8px 12px;
      font-size: 19px; /* Increased from 17px for better visibility */
      font-weight: 700;
      color: #1e293b;
      background-color: #e0f2fe; /* Light blue background for better contrast */
      border-left: 5px solid #0284c7; /* Thicker accent bar */
      border-radius: 6px;
      letter-spacing: 0.3px;
    }


    .summary-content p {
      margin-bottom: 12px;
    }

    .coauthor-section {
      margin-top: 25px;
    }

    .coauthor-item {
      background: #eef2ff;
      color: #312e81;
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 4px solid #4f46e5;
      font-weight: 500;
      transition: transform 0.2s ease;
    }

    .coauthor-item:hover {
      transform: translateX(5px);
      background: #e0e7ff;
    }

    /* Right panel */
    .graph-panel {
      background: white;
      border-radius: 18px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      position: relative;
    }

    #graph-container {
      width: 100%;
      height: 100%;
    }

    /* Scrollbar styling */
    .summary-panel::-webkit-scrollbar {
      width: 8px;
    }
    .summary-panel::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 10px;
    }
    .summary-panel::-webkit-scrollbar-thumb:hover {
      background-color: #94a3b8;
    }

    @media (max-width: 1000px) {
      .main-container {
        grid-template-columns: 1fr;
        height: auto;
      }
      .graph-panel {
        height: 500px;
      }
    }
  </style>
</head>

<body>

<header style="display:flex; justify-content:space-between; align-items:center;">
    
  <!-- LEFT: Page title -->
  <div>
    üìÑ Paper Summary & Author Graph
  </div>

  <!-- RIGHT: New Search button -->
  <button onclick="window.location.href='/main'"
          style="background:white; color:#2563eb; border:none;
                 padding:8px 15px; border-radius:8px;
                 font-weight:600; cursor:pointer;">
      New Search
  </button>
</header>

<div class="main-container">
  <!-- LEFT PANEL -->
  <div class="summary-panel">
    <h2 th:text="${title}">Paper Title</h2>

    <!-- Paper Identifiers Section -->
    <div th:if="${paper != null}" style="margin: 15px 0; padding: 12px; background: #f0f9ff; border-left: 4px solid #0284c7; border-radius: 8px;">
      <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #0369a1;">üìé Access Original Paper</h3>
      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <!-- DOI Link -->
        <a th:if="${paper.doi != null and !#strings.isEmpty(paper.doi)}"
           th:href="@{${paper.doi}}"
           target="_blank"
           style="display: inline-flex; align-items: center; padding: 6px 12px; background: #0284c7; color: white; 
                  text-decoration: none; border-radius: 6px; font-size: 13px; font-weight: 600; transition: background 0.2s;">
          üîó DOI
        </a>
        
        <!-- arXiv Link -->
        <a th:if="${paper.arxivId != null and !#strings.isEmpty(paper.arxivId)}"
           th:href="@{'https://arxiv.org/abs/' + ${paper.arxivId}}"
           target="_blank"
           style="display: inline-flex; align-items: center; padding: 6px 12px; background: #b91c1c; color: white; 
                  text-decoration: none; border-radius: 6px; font-size: 13px; font-weight: 600; transition: background 0.2s;">
          üìÑ arXiv
        </a>
        
        <!-- PMID Link (if available) -->
        <a th:if="${paper.pmid != null and !#strings.isEmpty(paper.pmid)}"
           th:href="@{'https://pubmed.ncbi.nlm.nih.gov/' + ${paper.pmid}}"
           target="_blank"
           style="display: inline-flex; align-items: center; padding: 6px 12px; background: #059669; color: white; 
                  text-decoration: none; border-radius: 6px; font-size: 13px; font-weight: 600; transition: background 0.2s;">
          üè• PubMed
        </a>
        
        <!-- OpenAlex Link (always available) -->
        <a th:if="${paper.openalexId != null and !#strings.isEmpty(paper.openalexId)}"
           th:href="@{${paper.openalexId}}"
           target="_blank"
           style="display: inline-flex; align-items: center; padding: 6px 12px; background: #7c3aed; color: white; 
                  text-decoration: none; border-radius: 6px; font-size: 13px; font-weight: 600; transition: background 0.2s;">
          üåê OpenAlex
        </a>
      </div>
    </div>

    <h3>üßæ Summary</h3>
    <!-- <div class="summary-content"
         th:utext="${#strings.replace(summary, '## ', '<h4 class=&quot;section-title&quot;>').replace('\n', '</h4><p>') + '</p>'}">
    </div> -->
    <div class="summary-content"
        th:utext="${#strings.replace(summary, '## ', '<h4 class=&quot;section-title&quot;>') 
                    .replace('\r\n', '</h4><p>') 
                    .replace('\n', '</h4><p>') + '</p>'}">
    </div>


    <div th:if="${paper != null and paper.authors != null and !#lists.isEmpty(paper.authors)}" class="coauthor-section">
      <h3>üë©‚Äçüî¨ Coauthors</h3>
      <div th:each="author : ${paper.authors}" class="coauthor-item"
           th:text="${author.displayName}">Coauthor Name</div>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="graph-panel">
    <!-- friendly error -->
    <div th:if="${error}"
         style="background:#fee2e2; color:#b91c1c; padding:14px;
                border-radius:12px; margin:25px;
                text-align:center; font-size:15px; font-weight:600;">
        <span th:text="${error}"></span>
    </div>

    <!-- container still exists -->
    <div id="graph-container"
         th:if="${error == null}">
    </div>

</div>

<script th:inline="javascript">
/*<![CDATA[*/
document.addEventListener("DOMContentLoaded", function () {
  let graphData = /*[[${graphJson}]]*/ '{"nodes":[],"edges":[]}';
  if (typeof graphData === "string") graphData = JSON.parse(graphData);

  const nodes = graphData.nodes.map(n => {
    const fullLabel = n.data.label;
    const shortLabel = fullLabel.split(" ").slice(0, 3).join(" ") +
      (fullLabel.split(" ").length > 3 ? "‚Ä¶" : "");
    if (n.data.type === 'paper') {
      return {
        id: n.data.id,
        label: shortLabel,
        title: fullLabel,
        shape: 'box',
        color: { background: '#2563eb', border: '#1e3a8a' },
        font: { color: 'white', size: 16, face: 'Inter', bold: true },
        widthConstraint: { maximum: 200 },
        margin: 10,
        type: n.data.type
      };
    } else {
      return {
        id: n.data.id,
        label: n.data.label,
        shape: 'circle',
        color: { background: '#f1f5f9', border: '#475569' },
        font: { color: '#111827', size: 14, face: 'Inter' },
        type: n.data.type
      };
    }
  });

  const edges = graphData.edges.map(e => ({
    from: e.data.source,
    to: e.data.target,
    color: { color: '#94a3b8' },
    width: 2,
    smooth: { type: 'dynamic' }
  }));

  const container = document.getElementById('graph-container');
  const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };

  const options = {
    layout: { improvedLayout: true },
    physics: {
      solver: 'forceAtlas2Based',
      forceAtlas2Based: {
        gravitationalConstant: -60,
        springLength: 200,
        springConstant: 0.05
      },
      stabilization: { iterations: 250 },
    },
    nodes: { shadow: true, borderWidth: 2 },
    edges: { shadow: false },
    interaction: {
      hover: true,
      tooltipDelay: 120,
      zoomView: true,
      dragNodes: true
    }
  };

  const network = new vis.Network(container, data, options);

  network.once("stabilizationIterationsDone", () => network.fit({ animation: true }));

  network.on("click", params => {
    if (params.nodes.length > 0) {
      const nodeId = params.nodes[0];
      const node = data.nodes.get(nodeId);
      if (node.type === "author") {
        window.location.href = '/professor-summary?id=' + node.id;
      }
    }
  });
});
/*]]>*/
</script>
</body>
</html>
