<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Research Topics Graph - ScholarSphere</title>
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: #f9fafb;
    }
    header {
      background: linear-gradient(90deg, #0d4f4c, #2563eb);
      color: white;
      padding: 16px 40px;
      font-size: 22px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }
    #graph-container {
      width: 90%;
      height: calc(100vh - 200px);
      margin: 25px auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }
    #pagination-controls {
      text-align: center;
      margin-bottom: 30px;
    }
    .page-btn {
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      margin: 0 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .page-btn:hover {
      background: #1e40af;
    }
    .page-info {
      font-size: 15px;
      color: #334155;
      margin-left: 10px;
    }
  </style>
</head>
<body>
<header>
  Research Topics for <span th:text="${professorName}"></span>
</header>

<div id="graph-container"></div>

<div id="pagination-controls">
  <button id="prev-page" class="page-btn">⬅ Prev</button>
  <button id="next-page" class="page-btn">Next ➡</button>
  <span id="page-info" class="page-info"></span>
</div>

<script th:inline="javascript">
/*<![CDATA[*/
document.addEventListener('DOMContentLoaded', function() {
  let graphData = /*[[${graphJson}]]*/ '{"nodes":[],"edges":[]}';
  if (typeof graphData === "string") graphData = JSON.parse(graphData);

  const profNode = graphData.nodes.find(n => n.data.type === "prof");
  const topics = graphData.nodes.filter(n => n.data.type === "topic");
  const edges = graphData.edges;

  // Pagination setup
  const PAGE_SIZE = 10;
  let currentPage = 1;
  const totalPages = Math.ceil(topics.length / PAGE_SIZE);

  const container = document.getElementById('graph-container');
  const prevBtn = document.getElementById('prev-page');
  const nextBtn = document.getElementById('next-page');
  const pageInfo = document.getElementById('page-info');

  let network;

  function renderPage(page) {
    const start = (page - 1) * PAGE_SIZE;
    const end = start + PAGE_SIZE;
    const topicsPage = topics.slice(start, end);

    const visNodes = [
      {
        id: profNode.data.id,
        label: profNode.data.label,
        shape: 'ellipse',
        color: { background: '#0d4f4c', border: '#083a38' },
        font: { color: 'white', size: 20, face: 'Inter' },
        size: 50
      },
      ...topicsPage.map(tp => ({
        id: tp.data.id,
        label: tp.data.label,
        shape: 'box',
        color: { background: '#2563eb', border: '#1e40af' },
        font: { color: '#fff', size: 14 },
        widthConstraint: { maximum: 160 }
      }))
    ];

    const visibleTopicIds = topicsPage.map(tp => tp.data.id);
    const visEdges = edges
      .filter(e => e.data.source === profNode.data.id && visibleTopicIds.includes(e.data.target))
      .map(e => ({
        from: e.data.source,
        to: e.data.target,
        color: { color: '#94a3b8' },
        width: 1.8,
        smooth: true
      }));

    const data = {
      nodes: new vis.DataSet(visNodes),
      edges: new vis.DataSet(visEdges)
    };

    const options = {
      layout: { improvedLayout: true },
      physics: {
        enabled: true,
        solver: 'forceAtlas2Based',
        forceAtlas2Based: { gravitationalConstant: -80, springLength: 200 },
        stabilization: { iterations: 200 }
      },
      nodes: { shadow: true, borderWidth: 2 },
      interaction: { hover: true, tooltipDelay: 100 }
    };

    if (network) network.destroy();
    network = new vis.Network(container, data, options);

    // Node click behavior
    network.on("click", params => {
      if (params.nodes.length > 0) {
        const nodeId = params.nodes[0];
        if (nodeId === profNode.data.id) {
          window.location.href = '/professor-summary?id=' + (profNode.data.id);
        } else {
          const topicName = nodeId.replaceAll('_', ' ');
          const authorId = profNode.data.id;
          const professorName = encodeURIComponent(profNode.data.label);
          const url = `/topic-papers-graph?id=${encodeURIComponent(authorId)}&topicName=${encodeURIComponent(topicName)}&name=${professorName}`;
          console.log("➡️ Redirecting to:", url);
          window.location.href = url;
        }
      }
    });

    // Update pagination info
    pageInfo.textContent = `Page ${page} of ${totalPages}`;
    prevBtn.disabled = (page === 1);
    nextBtn.disabled = (page === totalPages);
  }

  prevBtn.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      renderPage(currentPage);
    }
  });

  nextBtn.addEventListener('click', () => {
    if (currentPage < totalPages) {
      currentPage++;
      renderPage(currentPage);
    }
  });

  renderPage(currentPage);
});
/*]]>*/
</script>
</body>
</html>
